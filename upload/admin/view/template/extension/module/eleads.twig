{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="submit" form="form-eleads" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa fa-save"></i></button>
        <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a>
      </div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
          <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">
    {% if success %}
      <div class="alert alert-success"><i class="fa fa-check-circle"></i> {{ success }}</div>
    {% endif %}
    {% if error %}
      <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error }}</div>
    {% endif %}
    {% if error_warning %}
      <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}</div>
    {% endif %}

    <style>
      #content .eleads-wrap {max-width: 1200px;}
      #content .eleads-card {background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);}
      #content .eleads-card .panel-heading {background: #f8fafc; border-bottom: 1px solid #e5e7eb; border-top-left-radius: 10px; border-top-right-radius: 10px;}
      #content .eleads-card .panel-body {padding: 20px;}
      #content .eleads-tabs .nav-tabs {border-bottom: 0; margin: 0; padding: 12px 12px 0 16px;}
      #content .eleads-tabs .nav-tabs > li > a {border: 0; border-radius: 8px; margin-right: 6px; background: #f1f5f9; color: #0f172a;}
      #content .eleads-tabs .nav-tabs > li.active > a,
      #content .eleads-tabs .nav-tabs > li.active > a:focus,
      #content .eleads-tabs .nav-tabs > li.active > a:hover {background: #0f172a; color: #fff;}
      #content .eleads-section {margin-bottom: 16px;}
      #content .eleads-tree {border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; max-height: 360px; overflow: auto; background: #fff;}
      #content .eleads-tree-list {list-style: none; margin: 0; padding-left: 0;}
      #content .eleads-tree-item {display: flex; align-items: center; flex-wrap: wrap; gap: 6px; padding: 4px 2px;}
      #content .eleads-tree-children {width: 100%; margin-left: 22px; padding-left: 10px; border-left: 1px dashed #e5e7eb; display: none;}
      #content .eleads-tree-item.is-open > .eleads-tree-children {display: block;}
      #content .eleads-tree-toggle {width: 18px; height: 18px; border: 1px solid #cbd5f5; border-radius: 6px; background: #f8fafc; color: #0f172a; font-size: 12px; line-height: 1; padding: 0; cursor: pointer;}
      #content .eleads-tree-toggle::after {content: "+";}
      #content .eleads-tree-item.is-open > .eleads-tree-toggle::after {content: "−";}
      #content .eleads-tree-spacer {display: inline-block; width: 18px; height: 18px;}
      #content .eleads-tree-label {display: inline-flex; align-items: center; gap: 8px; cursor: pointer;}
      #content .eleads-tree-label input {position: absolute; opacity: 0; pointer-events: none;}
      #content .eleads-tree-box {width: 16px; height: 16px; border: 1px solid #94a3b8; border-radius: 4px; background: #f8fafc; display: inline-flex; align-items: center; justify-content: center; color: #0f172a; font-size: 12px; line-height: 1;}
      #content .eleads-tree-label input:checked + .eleads-tree-box {background: #d1fae5; border-color: #86efac;}
      #content .eleads-tree-label input:checked + .eleads-tree-box::after {content: "+";}
      #content .eleads-tree-label input:indeterminate + .eleads-tree-box {background: #e0f2fe; border-color: #7dd3fc;}
      #content .eleads-tree-label input:indeterminate + .eleads-tree-box::after {content: "−";}
      #content .eleads-tree-label.is-indeterminate .eleads-tree-box {background: #e0f2fe; border-color: #7dd3fc;}
      #content .eleads-tree-label.is-indeterminate .eleads-tree-box::after {content: "−";}
      #content .eleads-btn-group .btn {border-radius: 8px; border: 1px solid #e2e8f0; background: #f8fafc; color: #0f172a; margin-right: 6px;}
      #content .eleads-btn-group .btn:last-child {margin-right: 0;}
      #content .eleads-btn-group .btn:hover {background: #e2e8f0;}
      #content .eleads-btn-group .btn:active {background: #cbd5f5;}
      #content .eleads-help {color: #64748b; font-size: 12px;}
      #content .eleads-pill {display: inline-block; padding: 4px 8px; border-radius: 999px; background: #e2e8f0; font-size: 12px;}
      #content .eleads-template-help {background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; color: #0f172a; line-height: 1.5;}
      #content .eleads-template-help-title {font-weight: 600; margin-bottom: 4px;}
      #content .eleads-template-list {display: flex; flex-direction: column; gap: 12px;}
      #content .eleads-template-card-item {border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; background: #fff;}
      #content .eleads-template-card-head {display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;}
      #content .eleads-template-card-title {font-weight: 600; color: #334155;}
      #content .eleads-template-field {margin-bottom: 10px;}
      #content .eleads-template-field:last-child {margin-bottom: 0;}
      #content .eleads-template-field label {font-weight: 600; font-size: 12px; margin-bottom: 4px; color: #475569;}
      #content .eleads-lang-tabs.nav-tabs {border-bottom: 0; margin: 8px 0 12px; display: flex; flex-wrap: wrap; gap: 8px;}
      #content .eleads-lang-tabs.nav-tabs > li {float: none; margin: 0;}
      #content .eleads-lang-tabs.nav-tabs > li > a {border: 1px solid #cbd5e1; border-radius: 999px; background: #f8fafc; color: #334155; padding: 6px 12px; font-weight: 600; margin: 0;}
      #content .eleads-lang-tabs.nav-tabs > li.active > a,
      #content .eleads-lang-tabs.nav-tabs > li.active > a:hover,
      #content .eleads-lang-tabs.nav-tabs > li.active > a:focus {background: #0f172a; border-color: #0f172a; color: #fff;}
      #content .eleads-lang-content {border: 1px solid #e2e8f0; border-radius: 10px; background: #fcfdff; padding: 12px;}
    </style>
    {% if api_key_required %}
      <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-eleads" class="form-horizontal eleads-wrap">
        <div class="panel panel-default eleads-card">
          <div class="panel-heading"><strong>{{ entry_api_key_title }}</strong></div>
          <div class="panel-body">
            <p class="help-block">{{ entry_api_key_hint }}</p>
            {% if api_key_error %}
              <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ text_api_key_invalid }}</div>
            {% endif %}
            <div class="form-group">
              <label class="col-sm-2 control-label">{{ entry_api_key }}</label>
              <div class="col-sm-10">
                <input type="text" name="module_eleads_api_key" value="{{ api_key_value }}" class="form-control"/>
                <input type="hidden" name="module_eleads_api_key_submit" value="1"/>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">{{ button_save }}</button>
          </div>
        </div>
      </form>
    {% else %}
    <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-eleads" class="form-horizontal eleads-wrap">
      <div class="panel panel-default eleads-card eleads-tabs">
        <div class="panel-heading">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#tab-export" data-toggle="tab">{{ tab_export }}</a></li>
            <li><a href="#tab-filter" data-toggle="tab">{{ tab_filter }}</a></li>
            {% if seo_tab_available %}
            <li><a href="#tab-seo" data-toggle="tab">{{ tab_seo }}</a></li>
            {% endif %}
            <li><a href="#tab-api" data-toggle="tab">{{ tab_api }}</a></li>
            <li><a href="#tab-update" data-toggle="tab">{{ tab_update }}</a></li>
          </ul>
        </div>
        <div class="panel-body">
          <div class="tab-content">
            <div class="tab-pane active" id="tab-export">
              <div class="row">
                <div class="col-sm-12">
                  <div class="panel panel-default eleads-card eleads-section">
                  <div class="panel-heading"><strong>Feed URLs</strong></div>
                  <div class="panel-body">
                      <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                          <thead>
                            <tr>
                              <th>Feed Name</th>
                              <th>Feed URL</th>
                              <th style="width: 180px;">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for feed in feed_urls %}
                              <tr>
                                <td>{{ feed.name }}</td>
                                <td>
                                  <a href="{{ feed.url }}" target="_blank">{{ feed.url }}</a>
                                </td>
                              <td>
                                  <button type="button" class="btn btn-default btn-xs eleads-copy-btn" data-url="{{ feed.url }}">Copy</button>
                                  <a class="btn btn-default btn-xs" href="{{ feed.url }}" download="eleads-{{ feed.code }}.xml">Save</a>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-12">
                <div class="panel panel-default eleads-card eleads-section">
                  <div class="panel-heading"><strong>{{ entry_status }}</strong></div>
                  <div class="panel-body">
                    <div class="form-group">
                      <label class="col-sm-2 control-label">{{ entry_status }}</label>
                      <div class="col-sm-10">
                        <select name="module_eleads_status" class="form-control">
                          <option value="1" {% if module_eleads_status %}selected{% endif %}>{{ text_enabled }}</option>
                          <option value="0" {% if not module_eleads_status %}selected{% endif %}>{{ text_disabled }}</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
              <div class="row">
                <div class="col-sm-12">
                  <div class="panel panel-default eleads-card eleads-section">
                    <div class="panel-heading"><strong>{{ tab_export }}</strong></div>
                    <div class="panel-body">
          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_access_key }}</label>
            <div class="col-sm-10">
              <input type="text" name="module_eleads_access_key" value="{{ module_eleads_access_key }}" class="form-control"/>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_categories }}</label>
            <div class="col-sm-10">
              <div class="btn-group btn-group-sm eleads-btn-group" role="group" style="margin-bottom: 8px;">
                <button type="button" class="btn btn-default" id="eleads-categories-all" onclick="eleadsSelectAllCategories(true)">Select all</button>
                <button type="button" class="btn btn-default" id="eleads-categories-none" onclick="eleadsSelectAllCategories(false)">Select none</button>
              </div>
              <div class="eleads-tree" id="eleads-categories-tree">
                {{ categories_tree_html|raw }}
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_filter_attributes_toggle }}</label>
            <div class="col-sm-10">
              <select name="module_eleads_filter_attributes_enabled" class="form-control" id="eleads-filter-attributes-toggle">
                <option value="1" {% if module_eleads_filter_attributes_enabled %}selected{% endif %}>{{ text_enabled }}</option>
                <option value="0" {% if not module_eleads_filter_attributes_enabled %}selected{% endif %}>{{ text_disabled }}</option>
              </select>
            </div>
          </div>

          <div class="form-group eleads-filter-attributes-block" {% if not module_eleads_filter_attributes_enabled %}style="display:none"{% endif %}>
            <label class="col-sm-2 control-label">{{ entry_filter_attributes }}</label>
            <div class="col-sm-10">
              <div class="btn-group btn-group-sm eleads-btn-group" role="group" style="margin-bottom: 8px;">
                <button type="button" class="btn btn-default" id="eleads-attributes-all">Select all</button>
                <button type="button" class="btn btn-default" id="eleads-attributes-none">Select none</button>
              </div>
              <div class="eleads-tree">
                <ul class="eleads-tree-list eleads-attributes-list">
                  {% for attribute in attributes %}
                    <li class="eleads-tree-item">
                      <span class="eleads-tree-spacer"></span>
                      <label class="eleads-tree-label">
                        <input type="checkbox" name="module_eleads_filter_attributes[]" value="{{ attribute.attribute_id }}" {% if attribute.attribute_id in module_eleads_filter_attributes %}checked{% endif %}>
                        <span class="eleads-tree-box"></span>
                        <span class="eleads-tree-text">{{ attribute.name }}</span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_filter_option_values_toggle }}</label>
            <div class="col-sm-10">
              <select name="module_eleads_filter_option_values_enabled" class="form-control" id="eleads-filter-options-toggle">
                <option value="1" {% if module_eleads_filter_option_values_enabled %}selected{% endif %}>{{ text_enabled }}</option>
                <option value="0" {% if not module_eleads_filter_option_values_enabled %}selected{% endif %}>{{ text_disabled }}</option>
              </select>
            </div>
          </div>

          <div class="form-group eleads-filter-options-block" {% if not module_eleads_filter_option_values_enabled %}style="display:none"{% endif %}>
            <label class="col-sm-2 control-label">{{ entry_filter_option_values }}</label>
            <div class="col-sm-10">
              <div class="btn-group btn-group-sm eleads-btn-group" role="group" style="margin-bottom: 8px;">
                <button type="button" class="btn btn-default" id="eleads-options-all">Select all</button>
                <button type="button" class="btn btn-default" id="eleads-options-none">Select none</button>
              </div>
              <div class="eleads-tree">
                <ul class="eleads-tree-list eleads-options-list">
                  {% for option in options %}
                    {% if option.option_value is defined %}
                      {% for value in option.option_value %}
                        <li class="eleads-tree-item">
                          <span class="eleads-tree-spacer"></span>
                          <label class="eleads-tree-label">
                            <input type="checkbox" name="module_eleads_filter_option_values[]" value="{{ value.option_value_id }}" {% if value.option_value_id in module_eleads_filter_option_values %}checked{% endif %}>
                            <span class="eleads-tree-box"></span>
                            <span class="eleads-tree-text">{{ option.name }}: {{ value.name }}</span>
                          </label>
                        </li>
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_grouped }}</label>
            <div class="col-sm-10">
              <select name="module_eleads_grouped" class="form-control">
                <option value="1" {% if module_eleads_grouped %}selected{% endif %}>{{ text_enabled }}</option>
                <option value="0" {% if not module_eleads_grouped %}selected{% endif %}>{{ text_disabled }}</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_sync_enabled }}</label>
            <div class="col-sm-10">
              <select name="module_eleads_sync_enabled" class="form-control">
                <option value="1" {% if module_eleads_sync_enabled %}selected{% endif %}>{{ text_enabled }}</option>
                <option value="0" {% if not module_eleads_sync_enabled %}selected{% endif %}>{{ text_disabled }}</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_picture_limit }}</label>
            <div class="col-sm-10">
              <input type="number" name="module_eleads_picture_limit" value="{{ module_eleads_picture_limit }}" class="form-control"/>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_image_size }}</label>
            <div class="col-sm-10">
              <input type="text" name="module_eleads_image_size" value="{{ module_eleads_image_size }}" class="form-control"/>
              <div class="help-block">{{ help_image_size }}</div>
            </div>
          </div>

          <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_short_description_source }}</label>
            <div class="col-sm-10">
              <select name="module_eleads_short_description_source" class="form-control">
                <option value="meta_description" {% if module_eleads_short_description_source == 'meta_description' %}selected{% endif %}>Meta Description</option>
                <option value="description" {% if module_eleads_short_description_source == 'description' %}selected{% endif %}>Description</option>
              </select>
            </div>
          </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="tab-filter">
              <div class="row">
                <div class="col-sm-12">
                  <div class="panel panel-default eleads-card eleads-section">
                    <div class="panel-heading"><strong>{{ tab_filter }}</strong></div>
                    <div class="panel-body">
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_filter_pages_enabled }}</label>
                        <div class="col-sm-10">
                          <select name="module_eleads_filter_pages_enabled" class="form-control">
                            <option value="1" {% if module_eleads_filter_pages_enabled %}selected{% endif %}>{{ text_enabled }}</option>
                            <option value="0" {% if not module_eleads_filter_pages_enabled %}selected{% endif %}>{{ text_disabled }}</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_filter_max_index_depth }}</label>
                        <div class="col-sm-10">
                          <input type="number" min="1" max="10" name="module_eleads_filter_max_index_depth" value="{{ module_eleads_filter_max_index_depth }}" class="form-control"/>
                          <div class="help-block">{{ help_filter_depth_rules }}</div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_filter_whitelist_attributes }}</label>
                        <div class="col-sm-10">
                          <div class="btn-group btn-group-sm eleads-btn-group" role="group" style="margin-bottom: 8px;">
                            <button type="button" class="btn btn-default" id="eleads-whitelist-attributes-all">Select all</button>
                            <button type="button" class="btn btn-default" id="eleads-whitelist-attributes-none">Select none</button>
                          </div>
                          <div class="eleads-tree">
                            <ul class="eleads-tree-list eleads-whitelist-attributes-list">
                              {% for attribute in attributes %}
                                <li class="eleads-tree-item">
                                  <span class="eleads-tree-spacer"></span>
                                  <label class="eleads-tree-label">
                                    <input type="checkbox" name="module_eleads_filter_whitelist_attributes[]" value="{{ attribute.attribute_id }}" {% if attribute.attribute_id in module_eleads_filter_whitelist_attributes %}checked{% endif %}>
                                    <span class="eleads-tree-box"></span>
                                    <span class="eleads-tree-text">{{ attribute.name }}</span>
                                  </label>
                                </li>
                              {% endfor %}
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_filter_templates }}</label>
                        <div class="col-sm-10">
                          <div class="eleads-template-help" id="eleads-template-vars-help">
                            <div class="eleads-template-help-title">Available Variables</div>
                            <div id="eleads-template-vars-help-text">{{ help_filter_template_vars }}</div>
                          </div>
                          <div class="eleads-template-list" id="eleads-filter-templates-list">
                            {% for row in module_eleads_filter_templates %}
                              <div class="eleads-template-card-item">
                                <div class="eleads-template-card-head">
                                  <div class="eleads-template-card-title">Template #<span class="eleads-template-card-title-num">{{ loop.index }}</span></div>
                                  <button type="button" class="btn btn-danger btn-sm eleads-template-remove">{{ button_remove_template }}</button>
                                </div>
                                <div class="eleads-template-field">
                                  <label>{{ entry_filter_template_category }}</label>
                                  <select name="module_eleads_filter_templates[{{ loop.index0 }}][category_id]" class="form-control">
                                    <option value="0" {% if row.category_id == 0 %}selected{% endif %}>{{ text_all_categories }}</option>
                                    {% for c in filter_template_categories %}
                                      <option value="{{ c.category_id }}" {% if row.category_id == c.category_id %}selected{% endif %}>{{ c.name }}</option>
                                    {% endfor %}
                                  </select>
                                </div>
                                <ul class="nav nav-tabs eleads-lang-tabs">
                                  {% for lang in languages %}
                                    <li{% if loop.first %} class="active"{% endif %}>
                                      <a href="#eleads-template-{{ loop.parent.index0 }}-{{ loop.index0 }}" data-toggle="tab">{{ lang.code }}</a>
                                    </li>
                                  {% endfor %}
                                </ul>
                                <div class="tab-content eleads-lang-content">
                                  {% for lang in languages %}
                                    {% set t = row.translations[lang.code] is defined ? row.translations[lang.code] : {} %}
                                    <div class="tab-pane{% if loop.first %} active{% endif %}" id="eleads-template-{{ loop.parent.index0 }}-{{ loop.index0 }}">
                                      <div class="row">
                                        <div class="col-sm-6">
                                          <div class="eleads-template-field">
                                            <label>{{ entry_filter_template_h1 }}</label>
                                            <input type="text" name="module_eleads_filter_templates[{{ loop.parent.index0 }}][translations][{{ lang.code }}][h1]" value="{{ t.h1|default('') }}" class="form-control" />
                                          </div>
                                          <div class="eleads-template-field">
                                            <label>{{ entry_filter_template_meta_title }}</label>
                                            <input type="text" name="module_eleads_filter_templates[{{ loop.parent.index0 }}][translations][{{ lang.code }}][meta_title]" value="{{ t.meta_title|default('') }}" class="form-control" />
                                          </div>
                                        </div>
                                        <div class="col-sm-6">
                                          <div class="eleads-template-field">
                                            <label>{{ entry_filter_template_meta_description }}</label>
                                            <textarea name="module_eleads_filter_templates[{{ loop.parent.index0 }}][translations][{{ lang.code }}][meta_description]" rows="3" class="form-control">{{ t.meta_description|default('') }}</textarea>
                                          </div>
                                          <div class="eleads-template-field">
                                            <label>{{ entry_filter_template_meta_keywords }}</label>
                                            <textarea name="module_eleads_filter_templates[{{ loop.parent.index0 }}][translations][{{ lang.code }}][meta_keywords]" rows="3" class="form-control">{{ t.meta_keywords|default('') }}</textarea>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="row">
                                        <div class="col-sm-12">
                                          <div class="eleads-template-field">
                                            <label>{{ entry_filter_template_short_description }}</label>
                                            <textarea name="module_eleads_filter_templates[{{ loop.parent.index0 }}][translations][{{ lang.code }}][short_description]" rows="4" class="form-control">{{ t.short_description|default('') }}</textarea>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="row">
                                        <div class="col-sm-12">
                                          <div class="eleads-template-field">
                                            <label>{{ entry_filter_template_description }}</label>
                                            <textarea name="module_eleads_filter_templates[{{ loop.parent.index0 }}][translations][{{ lang.code }}][description]" rows="5" class="form-control">{{ t.description|default('') }}</textarea>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  {% endfor %}
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                          <button type="button" class="btn btn-primary" id="eleads-filter-template-add">{{ button_add_template }}</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {% if seo_tab_available %}
            <div class="tab-pane" id="tab-seo">
              <div class="row">
                <div class="col-sm-12">
                  <div class="panel panel-default eleads-card eleads-section">
                    <div class="panel-heading"><strong>{{ tab_seo }}</strong></div>
                    <div class="panel-body">
                      {% if not seo_url_enabled %}
                        <div class="alert alert-warning">{{ text_seo_url_disabled }}</div>
                      {% endif %}
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_seo_pages }}</label>
                        <div class="col-sm-10">
                          <select name="module_eleads_seo_pages_enabled" class="form-control" {% if not seo_url_enabled %}disabled{% endif %}>
                            <option value="1" {% if module_eleads_seo_pages_enabled %}selected{% endif %}>{{ text_enabled }}</option>
                            <option value="0" {% if not module_eleads_seo_pages_enabled %}selected{% endif %}>{{ text_disabled }}</option>
                          </select>
                          {% if not seo_url_enabled %}
                            <input type="hidden" name="module_eleads_seo_pages_enabled" value="0"/>
                          {% endif %}
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_sitemap_url }}</label>
                        <div class="col-sm-10">
                          <div class="input-group">
                            <input type="text" class="form-control" readonly value="{{ sitemap_url_full }}" id="eleads-sitemap-url" />
                            <span class="input-group-btn">
                              <button type="button" class="btn btn-default" onclick="eleadsCopySitemap('eleads-sitemap-url')">Copy</button>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <div class="tab-pane" id="tab-api">
              <div class="row">
                <div class="col-sm-8">
                <div class="panel panel-default eleads-card eleads-section">
                  <div class="panel-heading"><strong>{{ tab_api }}</strong></div>
                  <div class="panel-body">
                      <div class="form-group">
                        <label class="col-sm-2 control-label">{{ entry_api_key }}</label>
                        <div class="col-sm-10">
                          <input type="text" name="module_eleads_api_key" value="{{ module_eleads_api_key }}" class="form-control"/>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="tab-update">
              <div class="row">
                <div class="col-sm-8">
                <div class="panel panel-default eleads-card eleads-section">
                  <div class="panel-heading"><strong>{{ tab_update }}</strong></div>
                  <div class="panel-body">
                      <p>Local version: {{ update_info.local_version }}</p>
                      <p>Latest version: {{ update_info.latest_version }}</p>
                      {% if update_info.update_available %}
                        <a href="{{ update_url }}" class="btn btn-warning">{{ text_update }}</a>
                      {% else %}
                        <span class="label label-success eleads-pill">Up to date</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
    {% endif %}
    <script>
      (function() {
        window.eleadsSelectAllCategories = function(checked) {
          var tree = document.getElementById('eleads-categories-tree');
          if (!tree) return;
          var boxes = tree.querySelectorAll('input[type="checkbox"]');
          Array.prototype.forEach.call(boxes, function(cb) {
            cb.checked = checked;
            cb.indeterminate = false;
            var label = cb.closest('.eleads-tree-label');
            if (label) label.classList.remove('is-indeterminate');
          });
        };

        var allBtn = document.getElementById('eleads-categories-all');
        var noneBtn = document.getElementById('eleads-categories-none');
        var tree = document.getElementById('eleads-categories-tree');
        if (!tree) return;

        function copyText(text) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
          }
          var input = document.createElement('input');
          input.value = text;
          document.body.appendChild(input);
          input.select();
          try { document.execCommand('copy'); } catch (e) {}
          document.body.removeChild(input);
          return Promise.resolve();
        }

        var copyButtons = document.querySelectorAll('.eleads-copy-btn');
        Array.prototype.forEach.call(copyButtons, function(btn) {
          btn.addEventListener('click', function() {
            var url = btn.getAttribute('data-url') || '';
            copyText(url);
          });
        });

        function getAllCheckboxes() {
          return tree.querySelectorAll('input[type="checkbox"][name="module_eleads_categories[]"]');
        }

        function setLabelState(input) {
          var label = input.closest('.eleads-tree-label');
          if (!label) return;
          if (input.indeterminate) {
            label.classList.add('is-indeterminate');
          } else {
            label.classList.remove('is-indeterminate');
          }
        }

        function updateNodeState(li) {
          if (!li) return;
          var checkbox = li.querySelector('.eleads-tree-label input[type="checkbox"]');
          var childrenWrap = li.getElementsByClassName('eleads-tree-children')[0];
          if (!checkbox || !childrenWrap) return;
          var children = childrenWrap.querySelectorAll('input[type="checkbox"]');
          if (!children.length) return;
          var checkedCount = 0;
          var indeterminateCount = 0;
          Array.prototype.forEach.call(children, function(cb) {
            if (cb.indeterminate) indeterminateCount++;
            if (cb.checked) checkedCount++;
          });
          if (checkedCount === children.length) {
            checkbox.checked = true;
            checkbox.indeterminate = false;
          } else if (checkedCount === 0 && indeterminateCount === 0) {
            checkbox.checked = false;
            checkbox.indeterminate = false;
          } else {
            checkbox.checked = false;
            checkbox.indeterminate = true;
          }
          setLabelState(checkbox);
        }

        function updateParents(li) {
          var parent = li.parentElement;
          while (parent && parent !== tree) {
            if (parent.classList && parent.classList.contains('eleads-tree-item')) {
              updateNodeState(parent);
            }
            parent = parent.parentElement;
          }
        }

        function setChildren(li, checked) {
          var children = li.querySelectorAll('.eleads-tree-children input[type="checkbox"]');
          Array.prototype.forEach.call(children, function(cb) {
            cb.checked = checked;
            cb.indeterminate = false;
            setLabelState(cb);
          });
        }

        function initTreeState() {
          var items = tree.querySelectorAll('.eleads-tree-item');
          Array.prototype.forEach.call(items, function(li) {
            updateNodeState(li);
          });
          Array.prototype.forEach.call(items, function(li) {
            var childrenWrap = li.getElementsByClassName('eleads-tree-children')[0];
            if (!childrenWrap) return;
            var children = childrenWrap.querySelectorAll('input[type="checkbox"]');
            var open = false;
            Array.prototype.forEach.call(children, function(cb) {
              if (cb.checked || cb.indeterminate) {
                open = true;
              }
            });
            if (open) {
              li.classList.add('is-open');
            }
          });
        }

        tree.addEventListener('click', function(e) {
          var toggle = e.target.closest('.eleads-tree-toggle');
          if (toggle) {
            var li = toggle.closest('.eleads-tree-item');
            if (li) li.classList.toggle('is-open');
          }
        });

        var templateList = document.getElementById('eleads-filter-templates-list');
        var templateAddBtn = document.getElementById('eleads-filter-template-add');
        var templateHintText = document.getElementById('eleads-template-vars-help-text');
        var depthInput = document.querySelector('input[name="module_eleads_filter_max_index_depth"]');
        var templateNextIndex = templateList ? templateList.querySelectorAll('.eleads-template-card-item').length : 0;
        function templateCategoryOptions(selected) {
          var html = '<option value="0"' + (selected === 0 ? ' selected' : '') + '>{{ text_all_categories|e('js') }}</option>';
          {% for c in filter_template_categories %}
          html += '<option value="{{ c.category_id }}"' + (selected === {{ c.category_id }} ? ' selected' : '') + '>{{ c.name|e('js') }}</option>';
          {% endfor %}
          return html;
        }
        function refreshTemplateTitles() {
          if (!templateList) return;
          var nums = templateList.querySelectorAll('.eleads-template-card-title-num');
          Array.prototype.forEach.call(nums, function(node, idx) {
            node.textContent = String(idx + 1);
          });
        }
        function renderTemplateHint() {
          if (!templateHintText) return;
          var depth = parseInt(depthInput && depthInput.value ? depthInput.value : '1', 10);
          if (isNaN(depth) || depth < 1) depth = 1;
          var vars = ['{$category}', '{$category_h1}', '{$brand}', '{$sitename}'];
          for (var i = 1; i <= depth; i++) {
            if (i === 1) {
              vars.push('{$attribute_name}');
              vars.push('{$attributes_val}');
            } else {
              vars.push('{$attribute_name_' + i + '}');
              vars.push('{$attributes_val_' + i + '}');
            }
          }
          templateHintText.textContent = 'Variables: ' + vars.join(', ') + '.';
        }
        function bindTemplateRemove() {
          if (!templateList) return;
          var buttons = templateList.querySelectorAll('.eleads-template-remove');
          Array.prototype.forEach.call(buttons, function(btn) {
            btn.onclick = function() {
              var card = btn.closest('.eleads-template-card-item');
              if (card) card.remove();
              refreshTemplateTitles();
            };
          });
        }
        if (templateAddBtn && templateList) {
          templateAddBtn.addEventListener('click', function() {
            var index = templateNextIndex++;
            var card = document.createElement('div');
            card.className = 'eleads-template-card-item';
            card.innerHTML =
              '<div class="eleads-template-card-head">' +
                '<div class="eleads-template-card-title">Template #<span class="eleads-template-card-title-num"></span></div>' +
                '<button type="button" class="btn btn-danger btn-sm eleads-template-remove">{{ button_remove_template|e('js') }}</button>' +
              '</div>' +
              '<div class="eleads-template-field"><label>{{ entry_filter_template_category|e('js') }}</label><select name="module_eleads_filter_templates[' + index + '][category_id]" class="form-control">' + templateCategoryOptions(0) + '</select></div>' +
              '<ul class="nav nav-tabs eleads-lang-tabs">' +
                {% for lang in languages %}
                '<li{% if loop.first %} class="active"{% endif %}><a href="#eleads-template-new-' + index + '-{{ loop.index0 }}" data-toggle="tab">{{ lang.code|e('js') }}</a></li>' +
                {% endfor %}
              '</ul>' +
              '<div class="tab-content eleads-lang-content">' +
                {% for lang in languages %}
                '<div class="tab-pane{% if loop.first %} active{% endif %}" id="eleads-template-new-' + index + '-{{ loop.index0 }}">' +
                  '<div class="row">' +
                    '<div class="col-sm-6">' +
                      '<div class="eleads-template-field"><label>{{ entry_filter_template_h1|e('js') }}</label><input type="text" name="module_eleads_filter_templates[' + index + '][translations][{{ lang.code|e('js') }}][h1]" class="form-control" /></div>' +
                      '<div class="eleads-template-field"><label>{{ entry_filter_template_meta_title|e('js') }}</label><input type="text" name="module_eleads_filter_templates[' + index + '][translations][{{ lang.code|e('js') }}][meta_title]" class="form-control" /></div>' +
                    '</div>' +
                    '<div class="col-sm-6">' +
                      '<div class="eleads-template-field"><label>{{ entry_filter_template_meta_description|e('js') }}</label><textarea name="module_eleads_filter_templates[' + index + '][translations][{{ lang.code|e('js') }}][meta_description]" rows="3" class="form-control"></textarea></div>' +
                      '<div class="eleads-template-field"><label>{{ entry_filter_template_meta_keywords|e('js') }}</label><textarea name="module_eleads_filter_templates[' + index + '][translations][{{ lang.code|e('js') }}][meta_keywords]" rows="3" class="form-control"></textarea></div>' +
                    '</div>' +
                  '</div>' +
                  '<div class="row">' +
                    '<div class="col-sm-12">' +
                      '<div class="eleads-template-field"><label>{{ entry_filter_template_short_description|e('js') }}</label><textarea name="module_eleads_filter_templates[' + index + '][translations][{{ lang.code|e('js') }}][short_description]" rows="4" class="form-control"></textarea></div>' +
                    '</div>' +
                  '</div>' +
                  '<div class="row">' +
                    '<div class="col-sm-12">' +
                      '<div class="eleads-template-field"><label>{{ entry_filter_template_description|e('js') }}</label><textarea name="module_eleads_filter_templates[' + index + '][translations][{{ lang.code|e('js') }}][description]" rows="5" class="form-control"></textarea></div>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                {% endfor %}
              '</div>';
            templateList.appendChild(card);
            bindTemplateRemove();
            refreshTemplateTitles();
          });
          bindTemplateRemove();
          refreshTemplateTitles();
        }
        renderTemplateHint();
        if (depthInput) {
          depthInput.addEventListener('input', renderTemplateHint);
          depthInput.addEventListener('change', renderTemplateHint);
        }

        tree.addEventListener('change', function(e) {
          var input = e.target;
          if (!input.matches('input[type="checkbox"][name="module_eleads_categories[]"]')) return;
          var li = input.closest('.eleads-tree-item');
          if (!li) return;
          input.indeterminate = false;
          setLabelState(input);
          setChildren(li, input.checked);
          updateParents(li);
        });

        if (allBtn) {
          allBtn.addEventListener('click', function() {
            Array.prototype.forEach.call(getAllCheckboxes(), function(cb) {
              cb.checked = true;
              cb.indeterminate = false;
              setLabelState(cb);
            });
            initTreeState();
          });
        }
        if (noneBtn) {
          noneBtn.addEventListener('click', function() {
            Array.prototype.forEach.call(getAllCheckboxes(), function(cb) {
              cb.checked = false;
              cb.indeterminate = false;
              setLabelState(cb);
            });
            initTreeState();
          });
        }

        var attrToggle = document.getElementById('eleads-filter-attributes-toggle');
        var optToggle = document.getElementById('eleads-filter-options-toggle');
        var attrBlock = document.querySelector('.eleads-filter-attributes-block');
        var optBlock = document.querySelector('.eleads-filter-options-block');
        function applyToggle(toggle, block) {
          if (!toggle || !block) return;
          block.style.display = toggle.value === '1' ? '' : 'none';
        }
        function refresh() {
          applyToggle(attrToggle, attrBlock);
          applyToggle(optToggle, optBlock);
        }
        if (attrToggle) attrToggle.addEventListener('change', refresh);
        if (optToggle) optToggle.addEventListener('change', refresh);
        initTreeState();
        refresh();

        function bindSelectAll(buttonId, checked) {
          var btn = document.getElementById(buttonId);
          if (!btn) return;
          btn.addEventListener('click', function() {
            var group = btn.closest('.form-group, .row');
            if (!group) return;
            var items = group.querySelectorAll('input[type="checkbox"]');
            Array.prototype.forEach.call(items, function(cb) {
              cb.checked = checked;
            });
          });
        }
        bindSelectAll('eleads-attributes-all', true);
        bindSelectAll('eleads-attributes-none', false);
        bindSelectAll('eleads-options-all', true);
        bindSelectAll('eleads-options-none', false);
        bindSelectAll('eleads-whitelist-attributes-all', true);
        bindSelectAll('eleads-whitelist-attributes-none', false);
      })();
    </script>
  </div>
</div>
{{ footer }}
<script type="text/javascript"><!--
function eleadsCopySitemap(id) {
  var input = document.getElementById(id);
  if (!input) return;
  var text = input.value || '';
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text);
    return;
  }
  input.value = text;
  input.select();
  try { document.execCommand('copy'); } catch (e) {}
}
//--></script>
